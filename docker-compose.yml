version: '3.8'
services:
  clickhouse-server:
    image: clickhouse/clickhouse-server:22.8  # 22.8是LTS稳定版，推荐保留
    container_name: clickhouse-server
    privileged: true  # 解决Windows内核权限限制
    user: "root:root"  # 容器内以root运行，彻底规避权限问题
    ports:
      - "8123:8123"  # HTTP接口（DBeaver/客户端连接）
      - "9000:9000"  # TCP接口（clickhouse-client）
    environment:
      - CLICKHOUSE_PASSWORD=123456
      - CLICKHOUSE_TZ=Asia/Shanghai
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1  # 新增：开启权限管理（支持ALTER/UPDATE/DELETE）
      - CLICKHOUSE_DB=default  # 显式指定默认库，避免歧义
    # 使用Docker命名卷（自动管理权限，数据持久化）
    volumes:
      #- clickhouse-data:/var/lib/clickhouse
      - ./logs:/var/log/clickhouse-server  # 新增：日志持久化（便于排查问题）
    networks:
      - clickhouse-net  # 新增：自定义网络，避免与其他容器冲突
    restart: always  # 容器异常自动重启
    ulimits:  # 新增：调整系统限制，避免大数据写入时内存/文件句柄不足
      nofile:
        soft: 65536
        hard: 65536
      nproc:
        soft: 65536
        hard: 65536

# 自定义网络（隔离性更好）
networks:
  clickhouse-net:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1450  # 适配Windows WSL2网络MTU，避免数据包截断